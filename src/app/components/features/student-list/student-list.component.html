<!-- Student List Component Template -->
<div class="h-full max-h-full overflow-hidden p-4 lg:p-6 pt-0 lg:pt-0 flex flex-col">
  <!-- Kapat Butonu -->
  <div class="flex justify-end mb-1 flex-shrink-0">
    <button class="btn btn-ghost p-2" (click)="appState.collapseAll()" aria-label="Kapat">
      <span class="text-lg font-bold text-espresso">✕</span>
    </button>
  </div>

  <!-- Web Layout: 3 cols, Lg: 2 cols with analysis below -->
  <div class="grid gap-4 lg:grid-cols-2 xl:grid-cols-3 flex-1 h-full" style="grid-template-columns: 1fr 1.15fr 1.15fr;">
    <!-- Left: Student List -->
    <section class="flexible-content min-w-0 h-full flex flex-col -mt-4 lg:-mt-5">
      <div class="flex items-center justify-between mb-2  flex-shrink-0 px-1">
        <h4 class="text-base font-semibold text-espresso">Öğrenci Listesi</h4>
        <div class="ml-3 py-1">
          <input 
            type="search" 
            [value]="studentService.query()" 
            (input)="studentService.setQuery($any($event.target).value)" 
            placeholder="Ad / No ara…" 
            class="w-32 sm:w-40 md:w-48 rounded-md border border-borderGray bg-white px-3 py-2 text-sm placeholder:text-espresso/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-espresso"/>
        </div>
      </div>

      <!-- Sorting Header - Outside the scrollable area (same layout as exam list) -->
      <div class="flex bg-gray-50 text-sm font-medium text-espresso/70 border border-borderGray rounded-t-lg mb-0">
        <button class="flex-1 px-3 py-2 text-left hover:bg-gray-100 transition-colors rounded-tl-lg" (click)="studentService.sortStudentsBy('name')" [ngClass]="{'bg-primary/10': studentService.studentSortBy() === 'name'}">
          <span class="flex items-center gap-1">
            Ad
            <span *ngIf="studentService.studentSortBy() === 'name'" class="text-primary">
              {{ studentService.studentSortOrder() === 'asc' ? '↑' : '↓' }}
            </span>
          </span>
        </button>
        <button class="flex-1 px-3 py-2 text-left hover:bg-gray-100 transition-colors border-l border-borderGray rounded-tr-lg" (click)="studentService.sortStudentsBy('className')" [ngClass]="{'bg-primary/10': studentService.studentSortBy() === 'className'}">
          <span class="flex items-center gap-1">
            Sınıf
            <span *ngIf="studentService.studentSortBy() === 'className'" class="text-primary">
              {{ studentService.studentSortOrder() === 'asc' ? '↑' : '↓' }}
            </span>
          </span>
        </button>
      </div>
      
      <div class="h-[344px] overflow-y-auto divide-y divide-borderGray/60 border-l border-r border-b border-borderGray rounded-b-lg">
        <div *ngIf="studentService.filteredStudents().length===0" class="h-14 grid place-items-center text-espresso/60">
          Liste boş
        </div>
        
        <button 
          *ngFor="let student of studentService.filteredStudents(); index as i" 
          class="group w-full text-left h-14 px-3 relative" 
          [ngClass]="{'bg-infoSurface/30': studentService.selectedStudent()?.id===student.id}" 
          (mouseenter)="studentService.focusStudentIdx.set(i)" 
          (click)="studentService.selectStudent(student)">
          
          <div class="absolute left-0 top-0 h-full w-1" 
               [style.background]="studentService.focusStudentIdx()===i ? '#ea940c' : 'transparent'">
          </div>
          
          <div class="flex items-center justify-between h-full">
            <div class="flex-1 min-w-0">
              <div class="text-[17px] font-semibold text-espresso">{{ student.name }}</div>
              <div class="text-sm text-espresso/60">{{ student.className }} Sınıfı · No: {{ student.id }}</div>
            </div>
            <div *ngIf="studentService.selectedStudent()?.id===student.id" class="text-primary">✔</div>
          </div>
        </button>
      </div>
    </section>

    <!-- Middle: Exam List -->
    <section class="flexible-content hidden lg:block h-full flex flex-col" [class.animate-slide-in]="studentService.selectedStudent()">
      <div *ngIf="!studentService.selectedStudent()" class="h-[395px] border-2 border-dashed border-borderGray rounded-lg grid place-items-center text-espresso/50">Seçim yapın</div>
      <div *ngIf="studentService.selectedStudent()" class="flex-1 h-full flex flex-col">
        <div class="flex items-center justify-between mb-2 flex-shrink-0">
          <div class="text-base font-semibold text-espresso whitespace-nowrap min-h-0 text-ellipsis">{{ studentService.selectedStudent()?.name }} · Sınav Listesi</div>
        </div>
        
        <!-- Sorting Header - Outside the scrollable area -->
        <div class="flex bg-gray-50 text-sm font-medium text-espresso/70 border border-borderGray rounded-t-lg mb-0">
          <button class="flex-1 px-3 py-2 text-left hover:bg-gray-100 transition-colors rounded-tl-lg" (click)="studentService.sortExamsBy('subject')" [ngClass]="{'bg-primary/10': studentService.examSortBy() === 'subject'}">
            <span class="flex items-center gap-1">
            Sınav
              <span *ngIf="studentService.examSortBy() === 'subject'" class="text-primary">
                {{ studentService.examSortOrder() === 'asc' ? '↑' : '↓' }}
              </span>
            </span>
          </button>
          <button class="flex-1 px-3 py-2 text-left hover:bg-gray-100 transition-colors border-l border-borderGray rounded-tr-lg" (click)="studentService.sortExamsBy('date')" [ngClass]="{'bg-primary/10': studentService.examSortBy() === 'date'}">
            <span class="flex items-center gap-1">
              Tarih
              <span *ngIf="studentService.examSortBy() === 'date'" class="text-primary">
                {{ studentService.examSortOrder() === 'asc' ? '↑' : '↓' }}
              </span>
            </span>
          </button>
        </div>
        
        <!-- Exam List Content - Only the scrollable part -->
        <div class="h-[325px] overflow-y-auto divide-y divide-borderGray/60 border-l border-r border-b border-borderGray rounded-b-lg">
          <div *ngIf="studentService.sortedExams().length===0" class="h-12 grid place-items-center text-espresso/60">Sınav yok</div>
          <button 
            *ngFor="let exam of studentService.sortedExams(); index as i" 
            class="w-full text-left h-14 px-3 hover:bg-primary/10" 
            (mouseenter)="studentService.focusExamIdx.set(i)" 
            (click)="studentService.selectExam(exam)">
            <div class="flex items-center justify-between h-full">
              <div class="text-[16px] font-medium text-espresso">{{ exam.subject }}</div>
              <div class="text-sm text-espresso/70">{{ exam.date }}</div>
            </div>
          </button>
        </div>
      </div>
    </section>

    <!-- Right: Exam Analysis (xl) -->
    <section class="flexible-content hidden xl:block h-full flex flex-col" [class.animate-slide-in]="studentService.selectedExam()">
      <div *ngIf="!studentService.selectedExam()" class="h-[395px]  border-2 border-dashed border-borderGray rounded-lg grid place-items-center text-espresso/50">Seçim yapın</div>
      <div *ngIf="studentService.selectedExam()" class="flex-1 flex flex-col">
        <div class="text-base font-semibold text-espresso mb-2">Sınav Analizi — {{ studentService.selectedExam()?.subject }} {{ studentService.selectedExam()?.date }}</div>
        <div class="h-[360px] overflow-y-auto rounded-lg border border-borderGray">
          <div class="space-y-2 pb-4 p-3">
            <div class="card p-4">
              <div class="grid grid-cols-2 gap-4 items-center">
                <div>
                  <div class="text-xs text-espresso/60 mb-3">Ortalama Puan</div>
                  <div class="text-4xl font-semibold text-espresso">{{ studentService.selectedExam()?.score }} / 100</div>
                  <div class="mt-2 h-3 w-full bg-borderGray/50 rounded-full min-h-0">
                    <div class="h-full bg-primary" [style.width.%]="studentService.selectedExam()?.score || 0"></div>
                  </div>
                </div>
                <div>
                  <div class="text-xs text-espresso/60 mb-3">Kopya İhtimali</div>
                  <div class="text-2xl font-semibold text-espresso">%{{ studentService.selectedExam()?.copyProb }}</div>
                  <div class="mt-2 h-3 w-full bg-borderGray/50 rounded-full min-h-0">
                    <div class="h-full rounded-full" 
                         [ngStyle]="{ 
                           width: ((studentService.selectedExam()?.copyProb || 0) + '%'), 
                           background: (studentService.selectedExam()?.copyProb||0) < 15 ? '#22c55e' : 
                                      (studentService.selectedExam()?.copyProb||0) < 40 ? '#eab308' : '#ef4444' 
                         }"></div>
                  </div>
                </div>
                          </div>
          </div>
          </div>
        </div>
      </div>
    </section>

    <!-- On lg (2 cols), analysis below -->
    <section class="lg:col-span-2 xl:hidden flex flex-col" [class.hidden]="!studentService.selectedExam()">
      <div *ngIf="studentService.selectedExam()" class="animate-slide-in flex flex-col">
        <div class="text-base font-semibold text-espresso mb-2">Sınav Analizi — {{ studentService.selectedExam()?.subject }} {{ studentService.selectedExam()?.date }}</div>
        <div class="h-[350px] overflow-y-auto rounded-lg border border-borderGray">
          <div class="space-y-2 pb-6 p-3">
            <div class="card p-4">
              <div class="grid grid-cols-2 gap-4 items-center">
                <div>
                  <div class="text-xs text-espresso/60 mb-3">Ortalama Puan</div>
                  <div class="text-4xl font-semibold text-espresso">{{ studentService.selectedExam()?.score }} / 100</div>
                  <div class="mt-2 h-3 w-full bg-borderGray/50 rounded-full min-h-0">
                    <div class="h-full bg-primary" [style.width.%]="studentService.selectedExam()?.score || 0"></div>
                  </div>
                </div>
                <div>
                  <div class="text-xs text-espresso/60 mb-3">Kopya İhtimali</div>
                  <div class="text-2xl font-semibold text-espresso">%{{ studentService.selectedExam()?.copyProb }}</div>
                  <div class="mt-2 h-3 w-full bg-borderGray/50 rounded-full min-h-0">
                    <div class="h-full rounded-full" 
                         [ngStyle]="{ 
                           width: ((studentService.selectedExam()?.copyProb || 0) + '%'), 
                           background: (studentService.selectedExam()?.copyProb||0) < 15 ? '#22c55e' : 
                                      (studentService.selectedExam()?.copyProb||0) < 40 ? '#eab308' : '#ef4444' 
                         }"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>
